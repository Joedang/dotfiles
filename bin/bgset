#!/bin/bash
# Match search the backgrounds directory for files with a case-insensitive substring in their name.
# Refine the matches using each argument successively until one remains or all args are used.
# If more than one file makes it through all the filters, select one randomly.
# Set the selected file as the current background.
# Joe Shields
# 2018-08-08

# global constants
bgDir=~/img/backgrounds
bgProperty=/backdrop/screen0/monitor0/workspace0/last-image

# function definitions
countResults() {
	if [ -z "$imgResults" ]
	then
		echo 0
	else
		echo "$imgResults" | wc -l
	fi
}
showNames() {
	resultCount=$(countResults)
	if [[ $resultCount != 0 ]]
	then
		names=$(echo "$imgResults" | xargs -n 1 basename)
		echo -e $resultCount matching files:'\n'"$names"
	fi
}

# load the list of available files
imgResults=$(find  $bgDir -not -type d -iname \*"$1"\*)
if [ -z "$1" ]
then
	echo No filters given. Selecting random background.
fi

# apply remaining filters successively
# (still works if none are given)
## while we have a remaining argument and more than one remaining result
while [ ! -z "$1" -a $(countResults) -gt 1 ]
do
	echo
	echo filtering for \"$1\"...
	imgResults=$(echo "$imgResults" | grep -i -o ".*$1.*")
	# echo -e new imgResults is '\n' "$imgResults"
	showNames
	shift
done

# report any unused arguments
if [ ! -z "$1" ]
then
	echo
	echo -n 'unused filters: '
	while [ ! -z "$1" ]
	do
		echo -n "\"$1\" "
		shift
	done
fi

# report chosen file
resultCount=$(countResults)
echo
## more than one found
if [[ $resultCount > 1 ]]
then
	img=$(echo "$imgResults" | shuf -n 1)
## none found
elif [[ $resultCount == 0 ]]
then
	echo Couldn\'t find any matches!
	exit -1
## exactly one found
elif [[ $resultCount == 1 ]]
then
	img=$imgResults
## Uhhh...
else
	echo Something\'s gone terribly wrong, lol.
	exit -2
fi
echo -e chosen file:'\n'$img

# apply the background
xfconf-query --channel xfce4-desktop --property $bgProperty --set $img
